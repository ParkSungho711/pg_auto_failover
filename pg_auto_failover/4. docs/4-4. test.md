<h1>실제 운영 중 장애 시 auto-failover 실행 테스트</h1>
<br>
<h3>서비스 정상 작동 확인</h3>
[~]$ pg_autoctl show state <br>
Name |  Node |              Host:Port |       TLI: LSN |   Connection |      Reported State |      Assigned State <br>
-----+-------+------------------------+----------------+--------------+---------------------+-------------------- <br>
 mdw |     1 |   failoverprimary:5432 |  11: 0/451B7A0 |   read-write |             primary |             primary <br>
smdw |    10 | failoversecondary:5432 |  11: 0/4000000 |    read-only |           secondary |           secondary <br>

 <h3>primary 노드에서 서비스 종료</h3>
 [~]$ sudo systemctl stop pgautofailover.service <br>

 <h3>secondary에서 read-write 실행하고 primary로 승격됨</h3>
 [~]$ pg_autoctl show state <br>
Name |  Node |              Host:Port |       TLI: LSN |   Connection |      Reported State |      Assigned State <br>
-----+-------+------------------------+----------------+--------------+---------------------+-------------------- <br>
 mdw |     1 |   failoverprimary:5432 |  12: 0/451BBB0 |  read-only ! |           secondary |           secondary <br>
smdw |    10 | failoversecondary:5432 |  12: 0/451BBB0 |   read-write |             primary |             primary <br>

 <h3>old primary 서비스 재기동</h3>
 [~]$ sudo systemctl start pgautofailover.service <br>

 <h3>old primary 가 secondary 역할 진행</h3>
 [~]$ pg_autoctl show state <br>
Name |  Node |              Host:Port |       TLI: LSN |   Connection |      Reported State |      Assigned State <br>
-----+-------+------------------------+----------------+--------------+---------------------+-------------------- <br>
 mdw |     1 |   failoverprimary:5432 |  12: 0/4000000 |    read-only |           secondary |           secondary <br>
smdw |    10 | failoversecondary:5432 |  12: 0/451BBB0 |   read-write |        wait_primary |        wait_primary <br>

 <h3>수동으로 failback (switchover) 하여 old primary로 재승격</h3>
 [~]$ pg_autoctl perform switchover <br>
22:58:33 3642166 INFO  Targetting group 0 in formation "fotest" <br>
22:58:33 3642166 INFO  Listening monitor notifications about state changes in formation "fotest" and group 0 <br>
22:58:33 3642166 INFO  Following table displays times when notifications are received <br>
    Time | Name |  Node |              Host:Port |       Current State |      Assigned State <br>
---------+------+-------+------------------------+---------------------+-------------------- <br>
22:58:33 | smdw |    10 | failoversecondary:5432 |             primary |            draining <br>
22:58:33 |  mdw |     1 |   failoverprimary:5432 |           secondary |   prepare_promotion <br>
22:58:33 |  mdw |     1 |   failoverprimary:5432 |   prepare_promotion |   prepare_promotion <br>
22:58:33 |  mdw |     1 |   failoverprimary:5432 |   prepare_promotion |    stop_replication <br>
22:58:33 | smdw |    10 | failoversecondary:5432 |             primary |      demote_timeout <br>
22:58:33 | smdw |    10 | failoversecondary:5432 |            draining |      demote_timeout <br>
22:58:34 | smdw |    10 | failoversecondary:5432 |      demote_timeout |      demote_timeout <br>
22:58:35 |  mdw |     1 |   failoverprimary:5432 |    stop_replication |    stop_replication <br>
22:58:35 |  mdw |     1 |   failoverprimary:5432 |    stop_replication |        wait_primary <br>
22:58:35 | smdw |    10 | failoversecondary:5432 |      demote_timeout |             demoted <br>
22:58:35 | smdw |    10 | failoversecondary:5432 |             demoted |             demoted <br>
22:58:35 |  mdw |     1 |   failoverprimary:5432 |        wait_primary |        wait_primary <br>
22:58:35 | smdw |    10 | failoversecondary:5432 |             demoted |          catchingup <br>
22:58:35 | smdw |    10 | failoversecondary:5432 |          catchingup |          catchingup <br>
22:58:36 | smdw |    10 | failoversecondary:5432 |          catchingup |           secondary <br>
22:58:37 | smdw |    10 | failoversecondary:5432 |           secondary |           secondary <br>
22:58:37 |  mdw |     1 |   failoverprimary:5432 |        wait_primary |             primary <br>
22:58:37 |  mdw |     1 |   failoverprimary:5432 |             primary |             primary <br>

<h3>원상 복구 확인</h3>
[~]$ pg_autoctl show state <br>
Name |  Node |              Host:Port |       TLI: LSN |   Connection |      Reported State |      Assigned State <br>
-----+-------+------------------------+----------------+--------------+---------------------+-------------------- <br>
 mdw |     1 |   failoverprimary:5432 |  13: 0/451BFC0 |   read-write |             primary |             primary <br>
smdw |    10 | failoversecondary:5432 |  13: 0/451BFC0 |    read-only |           secondary |           secondary <br>
